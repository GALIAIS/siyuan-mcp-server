name: å‘å¸ƒåˆ°npm

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é…è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚v1.0.0

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: æ„å»ºé¡¹ç›®
        run: npm run build
      
      - name: è¿è¡Œæµ‹è¯•
        run: npm test -- --passWithNoTests
        continue-on-error: true
      
      - name: éªŒè¯åŒ…
        run: npm pack --dry-run
      
      - name: å‘å¸ƒåˆ°npm
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸš€ SiYuan MCP Server ${{ github.ref_name }}
            
            ### ğŸ“¦ npm åŒ…å·²å‘å¸ƒ
            
            å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
            
            \`\`\`bash
            # å…¨å±€å®‰è£…
            npm install -g siyuan-mcp-server@${{ github.ref_name }}
            
            # é¡¹ç›®ä¸­å®‰è£…
            npm install siyuan-mcp-server@${{ github.ref_name }}
            \`\`\`
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [npm åŒ…åœ°å€](https://www.npmjs.com/package/siyuan-mcp-server)
            - [ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
